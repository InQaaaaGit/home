# Работа с кастомными полями пользователей в CDO UNTI 2035 BAS

## Обзор

Плагин использует кастомные поля профиля пользователя для получения UNTI ID, который используется в xAPI statements как `actor->account->name`. Это позволяет связывать активность в Moodle с внешними системами (например, Bitrix).

## Компоненты системы

### 1. UserFieldService
Сервис для работы с кастомными полями пользователей:
- `get_user_field_value()` - получает значение любого кастомного поля
- `get_unti_id()` - получает UNTI ID из настроенного поля с fallback на User ID
- `field_exists()` - проверяет существование поля
- `get_all_user_fields()` - получает все кастомные поля пользователя

### 2. Настройка в админке
В настройках плагина есть поле **"UNTI User Field"** для указания короткого имени кастомного поля.

### 3. Тестовая страница
`user_field_test.php` - страница для тестирования и настройки кастомных полей.

## Настройка

### Шаг 1: Создание кастомного поля
1. Идите в **Администрирование → Пользователи → Поля профиля пользователя**
2. Создайте новое поле:
   - **Тип**: Текстовое поле
   - **Короткое имя**: `bitrix_lead_id` (или другое)
   - **Название**: "Bitrix Lead ID" 
   - **Видимость**: настройте по потребности

### Шаг 2: Настройка плагина
1. Идите в **Администрирование → Плагины → Локальные плагины → CDO UNTI 2035 BAS**
2. В поле **"UNTI User Field"** укажите короткое имя поля: `bitrix_lead_id`

### Шаг 3: Заполнение полей пользователей
1. В профилях пользователей заполните созданное поле
2. Значение будет использоваться как UNTI ID в xAPI statements

## Тестирование

1. Зайдите на `/local/cdo_unti2035bas/user_field_test.php`
2. Проверьте:
   - Настроено ли поле корректно
   - Есть ли значение у текущего пользователя
   - Какой UNTI ID будет использован

## Логика fallback

Если кастомное поле не настроено или пусто, система использует User ID Moodle как UNTI ID.

## Примеры использования

```php
// Получить UNTI ID пользователя
$untiId = user_field_service::get_unti_id($userid);

// Получить значение конкретного поля
$bitrixId = user_field_service::get_user_field_value($userid, 'bitrix_lead_id');

// Проверить существование поля
if (user_field_service::field_exists('bitrix_lead_id')) {
    // поле существует
}
```

## Архитектура

Система использует официальные функции Moodle Core:
- `profile_user_record()` - для получения данных профиля
- `profile_get_custom_field_data_by_shortname()` - для проверки полей
- `profile_get_custom_fields()` - для получения всех полей

Это обеспечивает совместимость с будущими версиями Moodle и правильную работу с кешированием. 